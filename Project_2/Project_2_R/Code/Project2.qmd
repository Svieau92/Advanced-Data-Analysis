---
title: "Advanced Data Analysis - Project 2"
author: "Sean Vieau"
date: "October 9, 2024"
editor: visual
output: html_document
toc: true
---

```{r setup, include=FALSE}
# Sets the default for all chunks as echo = TRUE (ensures they show unless specified not to)
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The aim of the current study is to assess how treatment response differs for HIV+ patients 2 years after initiating Highly Active Antiretroviral Therapy (HAART) based on hard drug usage (such as heroin or cocaine). This study is of particular scientific interest because it is unclear whether the use of hard drugs inhibits the immune system in humans; treatment strategies may differ based on these results. The researchers are interested in comparing subjects who never used hard drugs to current hard drug users (those that use hard drugs at year 2) or previous hard drug users (those who used drugs at year 0 or 1). Outcomes of interest are: viral load (HIV copies in a mL of blood), CD4+ T cell count (a measure of immunologic health), and aggregate physical and quality of life scores from the SF-36.

The clinical hypothesis is that, if hard drugs inhibit the immune system in humans, subjects who currently or previously used hard drugs will have higher viral load and lower CD4+ T cell counts than those who never used hard drugs. Additionally, the researchers are interested in knowing if potential differences between the drug use groups can be explained by differences in adherence to the treatment regimen. The researchers are agnostic on how quality of life changes after treatment, since side effects of the treatment are significant.

The project description provided by the PI is available below:

<div style="text-align: center;">
  <img src="/Project_2/Project_2_R/Media/Project2_description1.png" width="85%"/>
</div>

# Method

**Study Design**

This is a secondary data analysis of the Multicenter AIDS Cohort Study, an ongoing prospective cohort study investigating the natural and treated disease progression of HIV-1 in bisexual men in 4 major cities in the U.S. Measurements for all variables were taken once per year over an 8-year time period; however, the current analysis is only concerned with treatment outcomes after 2 years of HAART. Data was received as a longform .csv file containing 33 columns along with a data dictionary. The main outcomes of interest are viral load, CD4+ T cell count, and aggregate physical and quality of life scores. Adherence to treatment regiment will be investigated as a potential confounder.

Potential covariates of interest include: marijuana usage since last visit and frequency of usage, income, BMI, high blood pressure, diabetes, liver disease stage 3 / 4, kidney disease, frailty related phenotype, total cholesterol, triglycerides, fasting LDL, dyslipidemia, depression score, smoking status, alcohol use since last visit, heroin or opiate use since last visit, intravenous drug use since last visit, race, education at baseline, age, if they took ART at the visit or if they have ever taken it before, and years since initiating ART.

## Data Preparation

First we load the necessary packages

```{r, message = FALSE}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(knitr)
library(naniar)
library(kableExtra)
library(table1)
library(purrr)
library(tidyr) # Used for reshaping
```

Then we import the data set.

```{r, message = FALSE}
data <- read_csv("C:/Users/sviea/Documents/Portfolio/Project_2/Project_2_R/RawData/hiv_dataset.csv")
```

And take a look.

```{r}
glimpse(data)
```

Everything appears properly formatted, however all our categorical variables are coded as doubles.

Let's take a look at the header for good measure.

```{r}
kable(head(data), format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

We can see the data set is in long form. Let's convert that to wideform.

```{r}

# Filter data to only include 2 years
data_2 <- data %>%
  filter(years <= 2)

data_wide <- pivot_wider(data_2, id_cols = newid, names_from = years, values_from = -c(newid, years))

kable(head(data_wide), format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

Missingness

```{r}
gg_miss_var(data)
```

This shows that we are missing the most values for LDL, TRIG, income, TCHOL, and ADH.

A closer examination reveals...

```{r}
vis_miss(data)
```

47% of `LDL`, 43% of `TRIG`, 23% of `income`, and 22% of `TCHOL`, and 15% of `ADH` values are missing.

`LDL`, `TRIG`, and income have egregious amounts of missing data. `ADH` may be acceptable, but it will be worth investigating missing trends with it and potentially performing MI or switching to a linear mixed model if it is a strong predictor of our dependent variables and should be included in the model. Fortunately, all other variables have <5% missing values and are acceptable, and can be kept as is.

```{r}
# Create a function to summarize each column
summarize_column <- function(column) {
  data.frame(
    Min = min(column, na.rm = TRUE),
    Max = max(column, na.rm = TRUE)
  )
}

# Apply the function to each column and bind the results into a single data frame
summary_df <- map_dfr(data_wide, summarize_column, .id = "Column") %>%
  mutate(across(everything(), ~ format(., scientific = FALSE))) # Eliminates scientific notation

# Pretty print the table
kable(summary_df, format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

# Apply the function to each column and bind the results into a single data frame
summary_df <- map_dfr(data, summarize_column, .id = "Column") %>%
  mutate(across(everything(), ~ format(., scientific = FALSE))) # Eliminates scientific notation
                                      
# Pretty print the table
kable(summary_df, format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

`income` is on a scale from 1-9, with 9 being do not wish to answer.

`BMI` at years 1 and 2 show the mins as -1 and maxes as 999+. The data dictionary says that -1 is an 'improbable value', and 999 is "insufficient data". Odd that the max for BMI_1 shows as 999.61449 instead of 999.

```{r}
hist(data_wide$BMI_0)
hist(data_wide$BMI_1)
hist(data_wide$BMI_2)
```

Takeaway here is we only use the baseline measure of `BMI` if we include this variable in our model.

Let's look at the frequencies we have for income

```{r}
hist(data_wide$income_0)
```


Will have to turn all variables into classes and so they have names.


```{r}
hist(data_wide$CESD_0)
barplot(table(data_wide$CESD_0))
```

vload 0 is huuuuuge. There are some crazy outliers or misentered data there

```{r}
hist(data_wide$VLOAD_0)
barplot(table(data_wide$VLOAD_0))
boxplot(data_wide$VLOAD_0)
hist(data_wide$VLOAD_1)
hist(data_wide$VLOAD_2)

```


Conclusion: our previous missing data visuals were not accurate! We need to go back through and filter out the values that were coded as missing, but did not show up as NA (e.g. the -1, 9, or 999 values)!

For example, CESD missing was coded as -1, not blank. Go through each variable and write that down. BMI, education no response is 9, 9 for a bunch is coded as insufficient data

```{r}
# Do that here.
```


to do

do cleaning, then plotting, then correlations.

create change scores.